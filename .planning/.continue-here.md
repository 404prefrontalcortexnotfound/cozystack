# Continue Here: Cozystack Dashboard Security

## Session Context
- **Date**: 2026-01-19
- **Project**: cozy-stack
- **Phase**: Dashboard secured with Keycloak OIDC

## Infrastructure (Finland/HEL1)

| Server | Public IPv4 | Private IP | Talos Hostname | Role |
|--------|-------------|------------|----------------|------|
| cozy-ctrl-1 | 77.42.88.245 | 10.0.0.2 | talos-16aa3 | control-plane |
| cozy-ctrl-2 | 77.42.79.46 | 10.0.0.3 | talos-909a8 | control-plane |
| cozy-ctrl-3 | 77.42.85.170 | 10.0.0.4 | talos-7003c | control-plane |
| cozy-ax41 | 65.21.129.221 | 10.0.1.101 | cozy-ctrl-4 | control-plane + worker |

## Cluster Access

```bash
export KUBECONFIG=/Users/bobrain/code/cozy-stack/hetzner-cluster/kubeconfig
export TALOSCONFIG=/Users/bobrain/code/cozy-stack/hetzner-cluster/talosconfig

kubectl get nodes
kubectl get helmrelease -A | grep -v True
```

## Current State

<completed_work>
- Enabled OIDC in Cozystack ConfigMap (`oidc-enabled: "true"`, `expose-services: "dashboard"`)
- Cozystack auto-deployed Keycloak stack:
  - keycloak (2 replicas)
  - keycloak-db (PostgreSQL HA with 2 replicas)
  - keycloak-operator
  - keycloak-configure (realm + client)
- Dashboard gatekeeper switched from token-proxy → oauth2-proxy
- Public ingresses created:
  - `dashboard.cozy.homi.zone` → oauth2-proxy → dashboard
  - `keycloak.cozy.homi.zone` → Keycloak admin console
- Tailscale ingress still works for private access
</completed_work>

## Access URLs

| URL | Auth | Purpose |
|-----|------|---------|
| `https://dashboard.cozy.homi.zone` | Keycloak OIDC | Public dashboard |
| `https://keycloak.cozy.homi.zone` | Admin console | User management |
| `https://cozy-dashboard-cozystack-dashboard-ingress.beagle-danio.ts.net` | Tailscale | Private dashboard |

## Keycloak Admin Credentials

```bash
# Get credentials
KUBECONFIG=~/code/cozy-stack/hetzner-cluster/kubeconfig \
  kubectl get secret keycloak-credentials -n cozy-keycloak \
  -o jsonpath='{.data}' | jq -r 'to_entries[] | "\(.key): \(.value | @base64d)"'
```

- **URL**: https://keycloak.cozy.homi.zone
- **User**: admin
- **Password**: IKijfV5UtevFEdp7

## Next Steps

1. **Create dashboard user in Keycloak**:
   - Log into Keycloak admin console
   - Switch to "cozy" realm (top-left dropdown)
   - Users → Add user
   - Set username, email
   - Credentials tab → Set password (uncheck "Temporary")

2. **Test dashboard login**:
   - Visit https://dashboard.cozy.homi.zone
   - Should redirect to Keycloak login
   - Login with created user
   - Should see dashboard with cluster data

3. **Optional - Configure additional identity providers**:
   - Keycloak supports Google, GitHub, OIDC federation
   - Configure in Keycloak → Identity Providers

## Key Files

- Kubeconfig: `/Users/bobrain/code/cozy-stack/hetzner-cluster/kubeconfig`
- Talosconfig: `/Users/bobrain/code/cozy-stack/hetzner-cluster/talosconfig`
- Node configs: `/Users/bobrain/code/cozy-stack/hetzner-cluster/nodes/`

## Cozystack Configuration (Applied)

```yaml
# ConfigMap cozy-system/cozystack
data:
  root-host: cozy.homi.zone
  oidc-enabled: "true"
  expose-services: dashboard
  bundle-name: paas-full
  bundle-enable: hetzner-robotlb
  bundle-disable: metallb
```

## Resume Command
```
/gsd:resume-work
```
